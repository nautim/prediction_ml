library(haven)
library(tidyverse)
library(estimatr)
library(lmtest)
library(sandwich)
library(stargazer)
library(caret)
library(grid)


# uploading data
df <- read_csv("/Users/nautim/Desktop/Data and Econometrics/Predictions with ML/morg2014.csv")


# choosing all Education, Training, and Library Occupations (codes here https://osf.io/57n9q/)
df_sub <- df %>%
  filter(occ2012 >= 2200 & occ2012 <= 2550)

df_sub$occ2012 <- as.factor(df_sub$occ2012)
summary(df_sub$occ2012)

# updating the category names and changing the reference category to teachers in elementary and middle school (the biggest category)
levels(df_sub$occ2012) <- c("postsec teachers", "preschool teachers", "elem & middle teachers", "second teachers", 
                            "special teachers", "other teachers", "archivists/museums", "librarians", "libr technics",
                            "teacher assists", "other educ workers")
df_sub$occ2012 = relevel(df_sub$occ2012, ref = "elem & middle teachers")
table(df_sub$occ2012)


# preparing the main dependent variable for analysis; creating a consistent earnings per hour indicator
df_sub <- df_sub %>% dplyr::mutate(wage = earnwke/uhourse)

## deleting missings which cannot be imputed
df_sub <- df_sub %>% filter(wage != Inf)

df_sub %>%
  ggplot(aes(x = wage)) +
  geom_histogram(binwidth = 2)

## plotting shows that there are some influential observations, and it could be better to use ln
## since I use ln and some people earn between 0 and 1, I also artificially increase all wages by one dollar (for computing purposes)
df_sub <- df_sub %>% dplyr::mutate(lnwage = log(wage + 1))

df_sub %>%
  ggplot(aes(x = lnwage)) +
  geom_histogram(binwidth = 0.3)
## now it looks almost perfectly Gaussian 


# preparing and summarising independent variables

## female
df_sub <- df_sub %>% dplyr::mutate(female = factor(as.numeric(sex == 2)))
summary(df_sub$female)

## union membership
df_sub <- df_sub %>% dplyr::mutate(union_mem = as.factor(ifelse(unionmme == "Yes", 1, ifelse(unionmme == "No", 0, NA))))
summary(df_sub$union_mem)

## age
summary(df_sub$age)
plot(density(df_sub$age))

## number of own children
summary(df_sub$ownchild)
plot(density(df_sub$ownchild))


# summary statistics of the main variables
df_sub %>% dplyr::select(wage, lnwage, female, union_mem, age, ownchild, occ2012) %>% Hmisc::describe()


# preliminary visualisations

## age vs. lnwage - slightly squared trend (model should include agesq)
ggplot(data = df_sub, aes(x = age, y = lnwage)) +
  geom_point(size = 1,  shape = 16, alpha = 0.8, show.legend=F, na.rm = TRUE) + 
  geom_smooth(method="loess", se=F, size=1, span=0.9) +
  labs(x = "age (years)",y = "ln(earnings per hour)") +
  theme_bw()

df_sub <- df_sub %>% dplyr::mutate(agesq = age^2)

## median wage by sex and occupations

df_sub %>%
  group_by(female) %>%
  summarise(wage = median(wage, na.rm = T)) %>%
  ggplot(aes(x = female, y = wage, fill = female)) + geom_bar(stat = "identity", width = 0.5) +
  theme_bw() + geom_text(aes(label = round(wage, 2)), position = position_stack(vjust = 0.5)) +
  labs(y = "median wage, $/hour") + theme(legend.position = "none")


df_sub %>%
  group_by(female, occ2012) %>%
  summarise(wage = median(wage, na.rm = T)) %>%
  ggplot(aes(x = occ2012, y = wage, fill = female)) +
  labs(y = "median wage, $/hour", x = "", title = "Occupations within the set") + theme_bw() +
  geom_bar(stat = "identity", width = 0.5, position = position_dodge()) +
  theme(axis.text.x = element_text(angle=90,hjust=1)) +
  geom_text(aes(label = round(wage, 1)), position = position_dodge(0.8), vjust = -0.5) +
  ylim(0, 35)

## median wage by union membership and occupations

df_sub %>%
  group_by(union_mem) %>%
  summarise(wage = median(wage, na.rm = T)) %>%
  ggplot(aes(x = union_mem, y = wage, fill = union_mem)) + geom_bar(stat = "identity", width = 0.5) +
  theme_bw() + geom_text(aes(label = round(wage, 2)), position = position_stack(vjust = 0.5)) +
  labs(y = "median wage, $/hour", x = "union membership") + theme(legend.position = "none")


df_sub %>%
  group_by(union_mem, occ2012) %>%
  summarise(wage = median(wage, na.rm = T)) %>%
  ggplot(aes(x = occ2012, y = wage, fill = union_mem)) +
  labs(y = "median wage, $/hour", x = "", title = "Occupations within the set") + theme_bw() +
  geom_bar(stat = "identity", width = 0.5, position = position_dodge()) +
  theme(axis.text.x = element_text(angle=90,hjust=1)) +
  geom_text(aes(label = round(wage, 1)), position = position_dodge(0.8), vjust = -0.5) +
  ylim(0, 35) + scale_fill_discrete(name = "union \n membership")


## number of children vs. lnwage - slightly squared trend (model should include ownchildsq)
df_sub %>%
  ggplot(aes(x = ownchild, y = lnwage)) +
  geom_jitter(size = 1,  shape = 16, alpha = 0.8, show.legend = F, na.rm = TRUE) + 
  geom_smooth(method = "loess", se = F, size = 1, span = 0.9) +
  labs(x = "number of children", y = "ln(earnings per hour)") +
  theme_bw()

df_sub <- df_sub %>% dplyr::mutate(ownchildsq = ownchild^2)




